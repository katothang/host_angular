import { enableProdMode, NgZone, PlatformRef, } from '@angular/core';
import { platformBrowser } from '@angular/platform-browser';
import { VERSION } from '@angular/core';
import { getGlobalStateSlice, setGlobalStateSlice, } from '../utils/global-state';
import { Router } from '@angular/router';
import { connectRouter } from './router-utils';
let ngZoneSharing = true;
let platformSharing = true;
let legacyMode = true;
export function getMajor(version) {
    const pre = version.match(/\d+/)[0];
    const post = version.match(/-.*/);
    if (!pre) {
        throw new Error('Cound not identify major version: ' + version);
    }
    if (post) {
        return pre + post[0];
    }
    return pre;
}
function getLegacyPlatformCache() {
    const platformCache = window;
    platformCache.platform = platformCache.platform || {};
    return platformCache;
}
function getLegacyPlatform(key) {
    const platform = getLegacyPlatformCache().platform[key];
    /**
     * If dependencies are not shared, platform with same version is different
     * and shared platform will not be returned.
     */
    return platform instanceof PlatformRef ? platform : null;
}
function setLegacyPlatform(key, platform) {
    getLegacyPlatformCache().platform[key] = platform;
}
function getLegacyNgZone() {
    return window['ngZone'];
}
function setLegacyNgZone(zone) {
    window['ngZone'] = zone;
}
/**
 * LEGACY IMPLEMENTATIONS END
 */
function getPlatformCache() {
    return (getGlobalStateSlice((state) => state.platformCache) ||
        setGlobalStateSlice({
            platformCache: new Map(),
        }).platformCache);
}
function setPlatform(version, platform) {
    if (platformSharing) {
        legacyMode && setLegacyPlatform(version.full, platform);
        getPlatformCache().set(version, platform);
    }
}
function getPlatform(options) {
    if (!platformSharing) {
        return options.platformFactory();
    }
    const versionResult = options.version();
    const version = versionResult === VERSION.full ? VERSION : versionResult;
    const versionKey = typeof version === 'string' ? version : version.full;
    let platform = getPlatformCache().get(version) ||
        (legacyMode && getLegacyPlatform(versionKey));
    if (!platform) {
        platform = options.platformFactory();
        setPlatform(VERSION, platform);
        options.production && enableProdMode();
    }
    return platform;
}
function getNgZone() {
    return (getGlobalStateSlice((state) => state.ngZone) ||
        getLegacyNgZone());
}
export function shareNgZone(zone) {
    if (ngZoneSharing) {
        legacyMode && setLegacyNgZone(zone);
        setGlobalStateSlice({ ngZone: zone });
    }
}
export function bootstrap(module, options) {
    ngZoneSharing = options.ngZoneSharing !== false;
    platformSharing = options.platformSharing !== false;
    legacyMode = options.activeLegacyMode !== false;
    options.platformFactory =
        options.platformFactory || (() => platformBrowser());
    options.version = options.version || (() => VERSION);
    if (ngZoneSharing && !options.compilerOptions?.ngZone) {
        options.compilerOptions = options.compilerOptions || {};
        options.compilerOptions.ngZone = getNgZone();
    }
    return getPlatform(options)
        .bootstrapModule(module, options.compilerOptions)
        .then((ref) => {
        if (options.appType === 'shell') {
            shareShellZone(ref.injector);
        }
        else if (options.appType === 'microfrontend') {
            connectMicroFrontendRouter(ref.injector);
        }
        return ref;
    });
}
function shareShellZone(injector) {
    const ngZone = injector.get(NgZone, null);
    if (!ngZone) {
        console.warn('No NgZone to share found');
        return;
    }
    shareNgZone(ngZone);
}
function connectMicroFrontendRouter(injector) {
    const router = injector.get(Router);
    const useHash = location.href.includes('#');
    if (!router) {
        console.warn('No router to connect found');
        return;
    }
    connectRouter(router, useHash);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9tZi10b29scy9zcmMvbGliL3dlYi1jb21wb25lbnRzL2Jvb3RzdHJhcC11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsY0FBYyxFQUdkLE1BQU0sRUFDTixXQUFXLEdBR1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzVELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEMsT0FBTyxFQUNMLG1CQUFtQixFQUNuQixtQkFBbUIsR0FDcEIsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBc0MvQyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFDekIsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDO0FBQzNCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztBQUV0QixNQUFNLFVBQVUsUUFBUSxDQUFDLE9BQWU7SUFDdEMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWxDLElBQUksQ0FBQyxHQUFHLEVBQUU7UUFDUixNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxHQUFHLE9BQU8sQ0FBQyxDQUFDO0tBQ2pFO0lBRUQsSUFBSSxJQUFJLEVBQUU7UUFDUixPQUFPLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEI7SUFFRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFlRCxT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QUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsUUFBa0I7SUFDeEMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNYLE9BQU8sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUN6QyxPQUFPO0tBQ1I7SUFDRCxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsMEJBQTBCLENBQUMsUUFBa0I7SUFDcEQsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUU1QyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1gsT0FBTyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQzNDLE9BQU87S0FDUjtJQUVELGFBQWEsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDakMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcGlsZXJPcHRpb25zLFxyXG4gIGVuYWJsZVByb2RNb2RlLFxyXG4gIEluamVjdG9yLFxyXG4gIE5nTW9kdWxlUmVmLFxyXG4gIE5nWm9uZSxcclxuICBQbGF0Zm9ybVJlZixcclxuICBUeXBlLFxyXG4gIFZlcnNpb24sXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IHBsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5pbXBvcnQgeyBWRVJTSU9OIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgZ2V0R2xvYmFsU3RhdGVTbGljZSxcclxuICBzZXRHbG9iYWxTdGF0ZVNsaWNlLFxyXG59IGZyb20gJy4uL3V0aWxzL2dsb2JhbC1zdGF0ZSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IGNvbm5lY3RSb3V0ZXIgfSBmcm9tICcuL3JvdXRlci11dGlscyc7XHJcblxyXG5leHBvcnQgdHlwZSBBcHBUeXBlID0gJ3NoZWxsJyB8ICdtaWNyb2Zyb250ZW5kJztcclxuXHJcbmV4cG9ydCB0eXBlIE9wdGlvbnMgPSB7XHJcbiAgcHJvZHVjdGlvbjogYm9vbGVhbjtcclxuICBwbGF0Zm9ybUZhY3Rvcnk/OiAoKSA9PiBQbGF0Zm9ybVJlZjtcclxuICBjb21waWxlck9wdGlvbnM/OiBDb21waWxlck9wdGlvbnMgJiBCb290c3RyYXBPcHRpb25zO1xyXG4gIHZlcnNpb24/OiAoKSA9PiBzdHJpbmcgfCBWZXJzaW9uO1xyXG4gIGFwcFR5cGU/OiBBcHBUeXBlO1xyXG4gIC8qKlxyXG4gICAqIE9wdC1vdXQgb2Ygbmdab25lIHNoYXJpbmcuXHJcbiAgICogTm90IHJlY29tbWFuZGVkLlxyXG4gICAqIERlZmF1bHQgdmFsdWUgdHJ1ZS5cclxuICAgKi9cclxuICBuZ1pvbmVTaGFyaW5nPzogYm9vbGVhbjtcclxuICAvKipcclxuICAgKiBPcHQtb3V0IG9mIHBsYXRmb3JtU2hhcmluZyBzaGFyaW5nLlxyXG4gICAqIFBvc3NpYmxlLCBpZiBkZXBlbmRlbmNpZXMgYXJlIG5vdCBzaGFyZWQgb3IgZWFjaCBib290c3RyYXBwZWRcclxuICAgKiByZW1vdGUgYXBwIHVzZXMgYSBkaWZmZXJlbnQgdmVyc2lvbi5cclxuICAgKiBEZWZhdWx0IHZhbHVlIHRydWUuXHJcbiAgICovXHJcbiAgcGxhdGZvcm1TaGFyaW5nPzogYm9vbGVhbjtcclxuICAvKipcclxuICAgKiBEZWFjdGl2YXRlIHN1cHBvcnQgZm9yIGxlZ2FjeSBtb2RlLlxyXG4gICAqIE9ubHkgcmVjb21tYW5kZWQgaWYgYWxsIHVzZWQgaW1wbGVtZW50YXRpb25zIGRlcGVuZCBvblxyXG4gICAqIEBhbmd1bGFyLWFyY2hpdGVjdHMvbW9kdWxlLWZlZGVyYXRpb24tdG9vbHMgPiAxMy4wLjEuXHJcbiAgICogRGVmYXVsdCB2YWx1ZSB0cnVlLlxyXG4gICAqL1xyXG4gIGFjdGl2ZUxlZ2FjeU1vZGU/OiBib29sZWFuO1xyXG59O1xyXG5cclxuZGVjbGFyZSBpbnRlcmZhY2UgQm9vdHN0cmFwT3B0aW9ucyB7XHJcbiAgbmdab25lPzogTmdab25lIHwgJ3pvbmUuanMnIHwgJ25vb3AnO1xyXG4gIG5nWm9uZUV2ZW50Q29hbGVzY2luZz86IGJvb2xlYW47XHJcbiAgbmdab25lUnVuQ29hbGVzY2luZz86IGJvb2xlYW47XHJcbn1cclxuXHJcbmxldCBuZ1pvbmVTaGFyaW5nID0gdHJ1ZTtcclxubGV0IHBsYXRmb3JtU2hhcmluZyA9IHRydWU7XHJcbmxldCBsZWdhY3lNb2RlID0gdHJ1ZTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRNYWpvcih2ZXJzaW9uOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gIGNvbnN0IHByZSA9IHZlcnNpb24ubWF0Y2goL1xcZCsvKVswXTtcclxuICBjb25zdCBwb3N0ID0gdmVyc2lvbi5tYXRjaCgvLS4qLyk7XHJcblxyXG4gIGlmICghcHJlKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdW5kIG5vdCBpZGVudGlmeSBtYWpvciB2ZXJzaW9uOiAnICsgdmVyc2lvbik7XHJcbiAgfVxyXG5cclxuICBpZiAocG9zdCkge1xyXG4gICAgcmV0dXJuIHByZSArIHBvc3RbMF07XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcHJlO1xyXG59XHJcblxyXG4vKipcclxuICogTEVHQUNZIElNUExFTUVOVEFUSU9OUyBTVEFSVFxyXG4gKlxyXG4gKiBDYW4gYmUgZGVwcmVjYXRlZCBpbiBsYXRlciBtYWpvciByZWxlYXNlcy5cclxuICpcclxuICogVG8gaW5jcmVhc2UgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgbGVnYWN5IGFuZCBjdXJyZW50IG5hbWVzcGFjZXNcclxuICogd2l0aGluIHRoZSB3aW5kb3cgb2JqZWN0IGFyZSB1c2VkLlxyXG4gKi9cclxuXHJcbmV4cG9ydCB0eXBlIExlZ2FjeVBsYXRmb3JtQ2FjaGUgPSB7XHJcbiAgcGxhdGZvcm06IFJlY29yZDxzdHJpbmcsIFBsYXRmb3JtUmVmPjtcclxufTtcclxuXHJcbmZ1bmN0aW9uIGdldExlZ2FjeVBsYXRmb3JtQ2FjaGUoKTogTGVnYWN5UGxhdGZvcm1DYWNoZSB7XHJcbiAgY29uc3QgcGxhdGZvcm1DYWNoZSA9IHdpbmRvdyBhcyB1bmtub3duIGFzIExlZ2FjeVBsYXRmb3JtQ2FjaGU7XHJcbiAgcGxhdGZvcm1DYWNoZS5wbGF0Zm9ybSA9IHBsYXRmb3JtQ2FjaGUucGxhdGZvcm0gfHwge307XHJcbiAgcmV0dXJuIHBsYXRmb3JtQ2FjaGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldExlZ2FjeVBsYXRmb3JtKGtleTogc3RyaW5nKTogUGxhdGZvcm1SZWYge1xyXG4gIGNvbnN0IHBsYXRmb3JtID0gZ2V0TGVnYWN5UGxhdGZvcm1DYWNoZSgpLnBsYXRmb3JtW2tleV07XHJcbiAgLyoqXHJcbiAgICogSWYgZGVwZW5kZW5jaWVzIGFyZSBub3Qgc2hhcmVkLCBwbGF0Zm9ybSB3aXRoIHNhbWUgdmVyc2lvbiBpcyBkaWZmZXJlbnRcclxuICAgKiBhbmQgc2hhcmVkIHBsYXRmb3JtIHdpbGwgbm90IGJlIHJldHVybmVkLlxyXG4gICAqL1xyXG4gIHJldHVybiBwbGF0Zm9ybSBpbnN0YW5jZW9mIFBsYXRmb3JtUmVmID8gcGxhdGZvcm0gOiBudWxsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRMZWdhY3lQbGF0Zm9ybShrZXk6IHN0cmluZywgcGxhdGZvcm06IFBsYXRmb3JtUmVmKTogdm9pZCB7XHJcbiAgZ2V0TGVnYWN5UGxhdGZvcm1DYWNoZSgpLnBsYXRmb3JtW2tleV0gPSBwbGF0Zm9ybTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TGVnYWN5Tmdab25lKCk6IE5nWm9uZSB7XHJcbiAgcmV0dXJuIHdpbmRvd1snbmdab25lJ107XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldExlZ2FjeU5nWm9uZSh6b25lOiBOZ1pvbmUpOiB2b2lkIHtcclxuICB3aW5kb3dbJ25nWm9uZSddID0gem9uZTtcclxufVxyXG5cclxuLyoqXHJcbiAqIExFR0FDWSBJTVBMRU1FTlRBVElPTlMgRU5EXHJcbiAqL1xyXG5cclxuZnVuY3Rpb24gZ2V0UGxhdGZvcm1DYWNoZSgpOiBNYXA8VmVyc2lvbiwgUGxhdGZvcm1SZWY+IHtcclxuICByZXR1cm4gKFxyXG4gICAgZ2V0R2xvYmFsU3RhdGVTbGljZShcclxuICAgICAgKHN0YXRlOiB7IHBsYXRmb3JtQ2FjaGU6IE1hcDxWZXJzaW9uLCBQbGF0Zm9ybVJlZj4gfSkgPT5cclxuICAgICAgICBzdGF0ZS5wbGF0Zm9ybUNhY2hlXHJcbiAgICApIHx8XHJcbiAgICBzZXRHbG9iYWxTdGF0ZVNsaWNlKHtcclxuICAgICAgcGxhdGZvcm1DYWNoZTogbmV3IE1hcDxWZXJzaW9uLCBQbGF0Zm9ybVJlZj4oKSxcclxuICAgIH0pLnBsYXRmb3JtQ2FjaGVcclxuICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRQbGF0Zm9ybSh2ZXJzaW9uOiBWZXJzaW9uLCBwbGF0Zm9ybTogUGxhdGZvcm1SZWYpOiB2b2lkIHtcclxuICBpZiAocGxhdGZvcm1TaGFyaW5nKSB7XHJcbiAgICBsZWdhY3lNb2RlICYmIHNldExlZ2FjeVBsYXRmb3JtKHZlcnNpb24uZnVsbCwgcGxhdGZvcm0pO1xyXG4gICAgZ2V0UGxhdGZvcm1DYWNoZSgpLnNldCh2ZXJzaW9uLCBwbGF0Zm9ybSk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQbGF0Zm9ybShvcHRpb25zOiBPcHRpb25zKTogUGxhdGZvcm1SZWYge1xyXG4gIGlmICghcGxhdGZvcm1TaGFyaW5nKSB7XHJcbiAgICByZXR1cm4gb3B0aW9ucy5wbGF0Zm9ybUZhY3RvcnkoKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHZlcnNpb25SZXN1bHQgPSBvcHRpb25zLnZlcnNpb24oKTtcclxuICBjb25zdCB2ZXJzaW9uID0gdmVyc2lvblJlc3VsdCA9PT0gVkVSU0lPTi5mdWxsID8gVkVSU0lPTiA6IHZlcnNpb25SZXN1bHQ7XHJcbiAgY29uc3QgdmVyc2lvbktleSA9IHR5cGVvZiB2ZXJzaW9uID09PSAnc3RyaW5nJyA/IHZlcnNpb24gOiB2ZXJzaW9uLmZ1bGw7XHJcblxyXG4gIGxldCBwbGF0Zm9ybSA9XHJcbiAgICBnZXRQbGF0Zm9ybUNhY2hlKCkuZ2V0KHZlcnNpb24gYXMgVmVyc2lvbikgfHxcclxuICAgIChsZWdhY3lNb2RlICYmIGdldExlZ2FjeVBsYXRmb3JtKHZlcnNpb25LZXkpKTtcclxuXHJcbiAgaWYgKCFwbGF0Zm9ybSkge1xyXG4gICAgcGxhdGZvcm0gPSBvcHRpb25zLnBsYXRmb3JtRmFjdG9yeSgpO1xyXG4gICAgc2V0UGxhdGZvcm0oVkVSU0lPTiwgcGxhdGZvcm0pO1xyXG4gICAgb3B0aW9ucy5wcm9kdWN0aW9uICYmIGVuYWJsZVByb2RNb2RlKCk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcGxhdGZvcm07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE5nWm9uZSgpOiBOZ1pvbmUge1xyXG4gIHJldHVybiAoXHJcbiAgICBnZXRHbG9iYWxTdGF0ZVNsaWNlKChzdGF0ZTogeyBuZ1pvbmU6IE5nWm9uZSB9KSA9PiBzdGF0ZS5uZ1pvbmUpIHx8XHJcbiAgICBnZXRMZWdhY3lOZ1pvbmUoKVxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzaGFyZU5nWm9uZSh6b25lOiBOZ1pvbmUpOiB2b2lkIHtcclxuICBpZiAobmdab25lU2hhcmluZykge1xyXG4gICAgbGVnYWN5TW9kZSAmJiBzZXRMZWdhY3lOZ1pvbmUoem9uZSk7XHJcbiAgICBzZXRHbG9iYWxTdGF0ZVNsaWNlKHsgbmdab25lOiB6b25lIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGJvb3RzdHJhcDxNPihcclxuICBtb2R1bGU6IFR5cGU8TT4sXHJcbiAgb3B0aW9uczogT3B0aW9uc1xyXG4pOiBQcm9taXNlPE5nTW9kdWxlUmVmPE0+PiB7XHJcbiAgbmdab25lU2hhcmluZyA9IG9wdGlvbnMubmdab25lU2hhcmluZyAhPT0gZmFsc2U7XHJcbiAgcGxhdGZvcm1TaGFyaW5nID0gb3B0aW9ucy5wbGF0Zm9ybVNoYXJpbmcgIT09IGZhbHNlO1xyXG4gIGxlZ2FjeU1vZGUgPSBvcHRpb25zLmFjdGl2ZUxlZ2FjeU1vZGUgIT09IGZhbHNlO1xyXG4gIG9wdGlvbnMucGxhdGZvcm1GYWN0b3J5ID1cclxuICAgIG9wdGlvbnMucGxhdGZvcm1GYWN0b3J5IHx8ICgoKSA9PiBwbGF0Zm9ybUJyb3dzZXIoKSk7XHJcbiAgb3B0aW9ucy52ZXJzaW9uID0gb3B0aW9ucy52ZXJzaW9uIHx8ICgoKSA9PiBWRVJTSU9OKTtcclxuXHJcbiAgaWYgKG5nWm9uZVNoYXJpbmcgJiYgIW9wdGlvbnMuY29tcGlsZXJPcHRpb25zPy5uZ1pvbmUpIHtcclxuICAgIG9wdGlvbnMuY29tcGlsZXJPcHRpb25zID0gb3B0aW9ucy5jb21waWxlck9wdGlvbnMgfHwge307XHJcbiAgICBvcHRpb25zLmNvbXBpbGVyT3B0aW9ucy5uZ1pvbmUgPSBnZXROZ1pvbmUoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBnZXRQbGF0Zm9ybShvcHRpb25zKVxyXG4gICAgLmJvb3RzdHJhcE1vZHVsZShtb2R1bGUsIG9wdGlvbnMuY29tcGlsZXJPcHRpb25zKVxyXG4gICAgLnRoZW4oKHJlZikgPT4ge1xyXG4gICAgICBpZiAob3B0aW9ucy5hcHBUeXBlID09PSAnc2hlbGwnKSB7XHJcbiAgICAgICAgc2hhcmVTaGVsbFpvbmUocmVmLmluamVjdG9yKTtcclxuICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmFwcFR5cGUgPT09ICdtaWNyb2Zyb250ZW5kJykge1xyXG4gICAgICAgIGNvbm5lY3RNaWNyb0Zyb250ZW5kUm91dGVyKHJlZi5pbmplY3Rvcik7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiByZWY7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2hhcmVTaGVsbFpvbmUoaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgY29uc3Qgbmdab25lID0gaW5qZWN0b3IuZ2V0KE5nWm9uZSwgbnVsbCk7XHJcbiAgaWYgKCFuZ1pvbmUpIHtcclxuICAgIGNvbnNvbGUud2FybignTm8gTmdab25lIHRvIHNoYXJlIGZvdW5kJyk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIHNoYXJlTmdab25lKG5nWm9uZSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbm5lY3RNaWNyb0Zyb250ZW5kUm91dGVyKGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gIGNvbnN0IHJvdXRlciA9IGluamVjdG9yLmdldChSb3V0ZXIpO1xyXG4gIGNvbnN0IHVzZUhhc2ggPSBsb2NhdGlvbi5ocmVmLmluY2x1ZGVzKCcjJyk7XHJcblxyXG4gIGlmICghcm91dGVyKSB7XHJcbiAgICBjb25zb2xlLndhcm4oJ05vIHJvdXRlciB0byBjb25uZWN0IGZvdW5kJyk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjb25uZWN0Um91dGVyKHJvdXRlciwgdXNlSGFzaCk7XHJcbn1cclxuIl19